<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Offline Planner</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
:root {
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#22c55e;
  --danger:#ef4444;
}
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
}
header {
  padding:12px;
  text-align:center;
  font-weight:600;
}
input,textarea,button {
  background:var(--card);
  color:var(--text);
  border:1px solid #1f2937;
  border-radius:8px;
  padding:10px;
}
#inputBox {
  width:100%;
  font-size:16px;
}
nav {
  display:flex;
  gap:6px;
  padding:8px;
  overflow-x:auto;
}
nav button {
  font-size:13px;
  white-space:nowrap;
}
section {
  padding:10px;
}
.task {
  background:var(--card);
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.done {
  opacity:.6;
  text-decoration:line-through;
}
.calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
}
.calendar div {
  background:var(--card);
  min-height:70px;
  padding:6px;
  font-size:12px;
}
.calendar b {
  color:var(--muted);
  font-size:11px;
}
textarea {
  width:100%;
  min-height:80px;
}
</style>
</head>

<body>

<header>ðŸ§  Planner</header>

<section>
<input id="inputBox" placeholder="Pay bill tomorrow 5pm #home !high remind 30m">
</section>

<nav>
<button onclick="setView('today')">Today</button>
<button onclick="setView('upcoming')">Upcoming</button>
<button onclick="setView('overdue')">Overdue</button>
<button onclick="setView('calendar')">Calendar</button>
<button onclick="setView('completed')">Completed</button>
<button onclick="setView('journal')">Journal</button>
</nav>

<section id="content"></section>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
if ("Notification" in window) {
  Notification.requestPermission();
}

let tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
let journal = JSON.parse(localStorage.getItem("journal") || "{}");
let view = "today";

const input = document.getElementById("inputBox");

input.addEventListener("keydown", e => {
  if (e.key === "Enter") addTask(input.value);
});

function addTask(text) {
  if (!text.trim()) return;

  let due = parseDate(text);

  let task = {
    id: Date.now(),
    text,
    due,
    done:false
  };

  tasks.push(task);
  logJournal("Added: " + text);
  save();
  scheduleReminder(task);
  input.value="";
  render();
}

function parseDate(text) {
  let d = new Date();
  if (text.includes("tomorrow")) d.setDate(d.getDate()+1);
  let time = text.match(/(\d{1,2})\s*(am|pm)/);
  if (time) {
    let h = parseInt(time[1])%12 + (time[2]==="pm"?12:0);
    d.setHours(h,0,0,0);
  }
  return d.toISOString();
}

function scheduleReminder(task) {
  if (Notification.permission !== "granted") return;
  let delay = new Date(task.due).getTime() - Date.now() - 30*60000;
  if (delay>0) {
    setTimeout(()=>{
      new Notification("â° Reminder",{ body: task.text });
    }, delay);
  }
}

function render() {
  let el = document.getElementById("content");
  el.innerHTML="";

  if (view==="calendar") return renderCalendar();
  if (view==="journal") return renderJournal();

  let now = new Date();

  tasks.filter(t=>{
    let d = new Date(t.due);
    if (view==="today") return !t.done && d.toDateString()===now.toDateString();
    if (view==="upcoming") return !t.done && d>now;
    if (view==="overdue") return !t.done && d<now;
    if (view==="completed") return t.done;
    return true;
  }).forEach(t=>{
    let div=document.createElement("div");
    div.className="task"+(t.done?" done":"");
    div.innerHTML=`
      <div>
        ${t.text}<br>
        <small>${new Date(t.due).toLocaleString()}</small>
      </div>
      <div>
        <button onclick="toggle(${t.id})">âœ”</button>
        <button onclick="removeTask(${t.id})">ðŸ—‘</button>
      </div>`;
    el.appendChild(div);
  });
}

function renderCalendar() {
  let el=document.getElementById("content");
  el.innerHTML="<h3>Calendar</h3>";
  let grid=document.createElement("div");
  grid.className="calendar";

  let d=new Date();
  d.setDate(1);
  let days=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();

  for(let i=1;i<=days;i++){
    let cell=document.createElement("div");
    cell.innerHTML="<b>"+i+"</b>";
    tasks.filter(t=>new Date(t.due).getDate()===i)
      .forEach(t=>cell.innerHTML+="â€¢ "+t.text+"<br>");
    grid.appendChild(cell);
  }
  el.appendChild(grid);
}

function renderJournal() {
  let el=document.getElementById("content");
  el.innerHTML="<h3>Journal</h3>";
  for (let d in journal) {
    el.innerHTML+=`<b>${d}</b><pre>${journal[d].join("\n")}</pre>`;
  }
  el.innerHTML+=`<textarea placeholder="Write note..." onblur="addJournal(this.value)"></textarea>`;
}

function addJournal(text){
  if(!text) return;
  logJournal(text);
  save();
  render();
}

function logJournal(text){
  let d=new Date().toISOString().slice(0,10);
  journal[d]=journal[d]||[];
  journal[d].push(text);
}

function toggle(id){
  let t=tasks.find(x=>x.id===id);
  t.done=!t.done;
  logJournal((t.done?"Completed: ":"Reopened: ")+t.text);
  save();render();
}

function removeTask(id){
  tasks=tasks.filter(t=>t.id!==id);
  save();render();
}

function save(){
  localStorage.setItem("tasks",JSON.stringify(tasks));
  localStorage.setItem("journal",JSON.stringify(journal));
}

function setView(v){ view=v; render(); }

render();
</script>
</body>
</html>
